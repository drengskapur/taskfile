# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json

name: Test Bun Installation

on:
  push:
    paths:
      - ".taskfiles/bun/**"
  pull_request:
    paths:
      - ".taskfiles/bun/**"
  workflow_dispatch:

jobs:
  test:
    name: Test Bun installation
    runs-on: ubuntu-22.04
    if: ${{ !github.event.act }} # Skip during local testing
    container:
      image: ubuntu:22.04
      options: --privileged --user root
    env:
      HOME: /root
      PATH: /bin:/usr/bin:/usr/local/bin
    defaults:
      run:
        shell: /bin/sh -e {0}
    steps:
      - uses: actions/checkout@v3

      - name: Install base system utilities
        run: |
          apt-get update
          apt-get install -y bash curl sudo

      - name: Install remaining dependencies
        run: |
          apt-get install -y jq unzip

      - name: Install Task
        run: |
          sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d -b /usr/local/bin
          task --version

      - name: Install Bun
        run: |
          pwd
          ls -la
          task install
          echo "Task exit code: $?"

      - name: Check Bun version
        run: |
          which bun || true
          bun --version

  test-local:
    name: Test Bun installation (Local)
    runs-on: ubuntu-22.04
    if: ${{ github.event.act }} # Only run during local testing
    container:
      image: ubuntu:22.04
      options: --privileged --user root
    env:
      HOME: /root
      PATH: /bin:/usr/bin:/usr/local/bin
    defaults:
      run:
        shell: /bin/sh -e {0}
    steps:
      - uses: actions/checkout@v3

      - name: Install base system utilities
        if: ${{ github.event.act }}
        run: |
          apt-get update
          apt-get install -y bash curl sudo

      - name: Install remaining dependencies
        if: ${{ github.event.act }}
        run: |
          apt-get install -y jq unzip

      - name: Install Task
        if: ${{ github.event.act }}
        run: |
          sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d -b /usr/local/bin
          task --version

      - name: Install Bun
        if: ${{ github.event.act }}
        run: |
          pwd
          ls -la
          echo "Current directory contents:"
          ls -la
          echo "Taskfile contents:"
          cat Taskfile.yml || true
          echo "Running task with verbose output:"
          task --verbose install
          echo "Task exit code: $?"

      - name: Check Bun version
        if: ${{ github.event.act }}
        run: |
          which bun || true
          bun --version
